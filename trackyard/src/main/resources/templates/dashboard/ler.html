<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body th:with="pageTitle='Ler QR Code', content=~{::content}"
      th:insert="~{fragments/_layout}">

<div th:fragment="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">Ler QR Code</h1>
    </div>
  
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Último QR lido</h5>
      <pre id="lastData" class="mb-0">Nenhum</pre>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Upload / Câmera</h5>

      <div class="mb-3">
          <label for="selectPonto" class="form-label"><b>1. Selecione o Ponto de Leitura:</b></label>
          <select class="form-select" id="selectPonto">
              <option value="">-- Selecione um ponto --</option>
              <option th:each="ponto : ${listaDePontos}" 
                      th:value="${ponto.idPonto()}" 
                      th:text="${ponto.nomePonto()} + ' (ID: ' + ${ponto.idPonto()} + ')'">
                  Ponto de Teste
              </option>
          </select>
      </div>
      <div class="row">
        <div class="col-md-6">
          <p><b>2. Use a câmera do Celular:</b></p>
          <video id="videoPreview" autoplay playsinline style="display:none; width:100%; border-radius:6px;"></video>
          <canvas id="captureCanvas" style="display:none;"></canvas>

          <div class="mt-2">
            <button class="btn btn-outline-primary me-1" id="btnOpenCam" onclick="openCamera()">Abrir câmera</button>
            <button class="btn btn-primary me-1" id="btnTakePhoto" onclick="takePhoto()" disabled>Capturar & Enviar</button>
            <button class="btn btn-outline-secondary" id="btnCloseCam" onclick="closeCamera()" disabled>Fechar câmera</button>
          </div>
        </div>

        <div class="col-md-6">
          <p><b>2. Ou envie um arquivo:</b></p>
          <input class="form-control" type="file" id="fileInput" accept="image/*" />
          <div class="mt-2">
            <button class="btn btn-outline-success" onclick="uploadImage()">Enviar</button>
          </div>
          <div class="mt-3">
            <strong>Resultado do upload:</strong>
            <pre id="uploadResult" class="mt-1">-</pre>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Logs</h5>
      <pre id="logs" class="mb-0">Pronto.</pre>
    </div>
  </div>

<script>
    const PY_API_BASE = 'http://localhost:8000';
    let lastQr = null;
    let videoStream = null;

    function log(msg) {
      const logs = document.getElementById('logs');
      const time = new Date().toLocaleTimeString();
      logs.innerText = `[${time}] ${msg}\n` + logs.innerText;
    }
    

    function refreshLast() {
      if (lastQr) {
        document.getElementById('lastData').innerText = JSON.stringify(lastQr, null, 2);
      } else {
        document.getElementById('lastData').innerText = 'Nenhum';
      }
    }

    // Função interna para validar e enviar o formulário
    async function sendImageToAPI(formData) {
        try {
            const res = await fetch(`${PY_API_BASE}/upload_image_and_decode`, { method: 'POST', body: formData });
            
            if (!res.ok) {
                const errorText = await res.text();
                alert('Erro ao enviar (API retornou ' + res.status + '): ' + errorText);
                log('Erro upload: ' + res.status + ' ' + errorText);
                return;
            }

            const json = await res.json();
            document.getElementById('uploadResult').innerText = JSON.stringify(json, null, 2);
            log('upload -> ' + JSON.stringify(json));
            
            if (json.found && json.sent_to_backend) {
              // json.data contém o payload original do QR
              // json.payload_sent contém o que foi enviado ao Java
              lastQr = json.payload_sent; 
              document.getElementById('lastData').innerText = JSON.stringify(lastQr, null, 2);
              log('Sucesso! Movimentação registrada no Java.');
            } else if (json.found) {
              log('QR encontrado, mas falhou ao enviar ao backend Java.');
            }

        } catch (e) {
            alert('Erro de rede ao enviar imagem: ' + e);
            log('Erro upload (rede): ' + e);
        }
    }

    // Validação principal
    function getSelectedPonto() {
        const idPonto = document.getElementById('selectPonto').value;
        if (!idPonto) {
            alert('Erro: Por favor, selecione um Ponto de Leitura primeiro.');
            return null;
        }
        return idPonto;
    }

    async function uploadImage() {
      const idPonto = getSelectedPonto();
      if (!idPonto) return; // Para se o ponto não foi selecionado

      const input = document.getElementById('fileInput');
      if (!input.files.length) { alert('Selecione uma imagem'); return; }
      
      const fd = new FormData();
      fd.append('file', input.files[0]);
      fd.append('idPonto', idPonto); // <-- ADICIONADO O ID DO PONTO

      log(`Enviando arquivo com idPonto: ${idPonto}`);
      await sendImageToAPI(fd);
    }

    async function openCamera() {
      
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        const video = document.getElementById('videoPreview');
        video.srcObject = videoStream;
        video.style.display = 'block';
        document.getElementById('btnTakePhoto').disabled = false;
        document.getElementById('btnCloseCam').disabled = false;
        document.getElementById('btnOpenCam').disabled = true;
        log('Câmera aberta no navegador');
      } catch (e) {
        alert('Não foi possível acessar a câmera: ' + e);
        log('Erro openCamera: ' + e);
      }
    }

    function closeCamera() {
      // ... (esta função não muda) ...
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      const video = document.getElementById('videoPreview');
      video.style.display = 'none';
      document.getElementById('btnTakePhoto').disabled = true;
      document.getElementById('btnCloseCam').disabled = true;
      document.getElementById('btnOpenCam').disabled = false;
      log('Câmera fechada');
    }

    async function takePhoto() {
      const idPonto = getSelectedPonto();
      if (!idPonto) return; // Para se o ponto não foi selecionado

      if (!videoStream) return alert('Abra a câmera primeiro');
      
      const video = document.getElementById('videoPreview');
      const canvas = document.getElementById('captureCanvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        const fd = new FormData();
        fd.append('file', blob, 'capture.png');
        fd.append('idPonto', idPonto); // <-- ADICIONADO O ID DO PONTO
        
        log(`Enviando captura com idPonto: ${idPonto}`);
        await sendImageToAPI(fd);

      }, 'image/png');
    }

    window.addEventListener('beforeunload', () => {
      // ... (esta função não muda) ...
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
      }
    });
  </script>

</div> </body>
</html>